<h1>Jamf Provisioner</h1>
<h2>An Automated Erase/Install Workflow for macOS and Jamf Pro</h2>
This script will set up a (almost) zero-touch automation process for workflows that require a computer to be erased and reprovisioned for a new user.<br><br>Currently you have two options to achieve this workflow; You can either boot the computer into recovery, reformat the drive, and then install a new version of macOS from a USB drive or internet recovery, or you can write your own erase/install script utilizing your own staged version of the "Install macOS" app and the startosinstall binary that comes with it. There are several drawbacks to these methods. The first method is obviously just very manual and time consuming, especially if you have a lot of machines to turn over all at once. The second method requires a good amount of scripting knowledge just to get it working, and even more if you want it to be pretty.<br><br>That's where the Jamf Provisioner comes in. This script is meant to be run once on an admin computer that is enrolled in Jamf Pro. It will use a series of API calls to generate all of the necessary objects in Jamf Pro to create a fully automated process that will download the latest version of the "Install macOS" installer on your fleet, stage it in a hidden area on the computer where the end user can't mess with it, and then make a self service policy that you can scope to your IT team so they can press one button from Self Service, walk away, and in 20 minutes have the computer back up at the setup assistant and be ready to be re-enrolled and provisioned for a new user.

<h2>Note: This script runs best on a computer that is enrolled in Jamf Pro since it utilizes some Jamf Helper dialogs while it's processing. If you run on a machine not enrolled, it will still work just fine. You just won't see anything while it processes its tasks.</h2>

<h2>What's under the hood?</h2>
As mentioned previously, this script is going to create 10 objects in your Jamf Pro. That's a lot of stuff, right? So what is it all doing? Here's a breakdown of what is created and how it all works together to automate this process.

1. First it will create a "Provisioning" category if one doesn't already exist. This is purely for organization purposes so you can easily find these objects later.
2. After that, an extension attribute is created that checks what version of the "Install macOS" app each computer has in the staging area. If the installer isn't in the staging area, it will report back "Not Installed".
3. Then it will generate 3 script objects that will live in the Scripts section of the Computer Management area in your Jamf Pro settings; I'll go over what each of these scripts does in the policy descriptions coming up.
4. Next it will create two Smart Computer Groups; The first one will be set to look for computers that have the latest version of "Install macOS ... .app" (latest released by Apple) staged on their computers. The second one will look for computers that DON'T have the latest version staged and are running at least macOS 10.15 or later. This process only works on 10.15 or later so it's necessary to have this as the target to kick off this process.
5. Finally it will create three policies to deploy the three scripts:
<br> 	- Policy 1 will deploy the first script to clear out any old versions of the "Install macOS" app from the Applications folder so that they don't accidentally screw up the process. Then it will use a Files and Processes payload to run the following command "softwareupdate --fetch-full-installer; jamf policy -event moveInstaller". That will download the latest released version of the "Install macOS" app from Apple and then immediately kick off Policy 2. This policy is scoped to the second smart group (Computers without the latest version of the installer staged that are also running 10.15 or later) This policy will be disabled by default so that you can either choose to enable it right away, or enable it on your own time.
<br>	- Policy 2 will then be triggered immediately to run the second script which moves the newly downloaded installer from /Applications to /private/var/macOSInstaller, save the version number of the installer in a text file in the same directory, and then package the installer up in a DMG and delete the original. We save the version number in the text file because that is what the extension attribute will be reading to report to the smart group. We package the installer into a DMG because if it's ever used to upgrade instead of erase/install macOS will delete it when it's done and we want to keep it there for it to be available for a full wipe. This policy is scoped to all computers because it only has a custom event for a trigger that should only be triggered at the end of the first policy.
<br>	- Policy 3 will be made available in Self Service and won't be scoped initially. Once you've run the script you'll want to come back to this policy and scope it to the second smart group (Provisioning: Targets for Policy 3) and limit it to whoever should be able to run that policy, like the IT LDAP group or something like that. Or if you don't have LDAP configured but still only want certain people to be able to run it, I've also added a custom trigger of "resetComputer" to this policy so it can be triggered on a computer by running "sudo jamf policy -event resetComputer" so just turn off the Self Service aspect to hide it from end users. But essentially this policy will deploy the third script when it's run which will initiate the erase/install process along with a nice full screen Jamf Helper window to keep the user from messing with the computer while the process starts. Due to the nature of the startosinstall binary, in order to do an erase/install the installer version and the version of macOS on the computer need to match. So if they don't match, this script will first upgrade the computer to the version of the installer. Then you can run the script again to initiate the erase/install sequence. The Jamf Helper window will tell you whether it is erasing or upgrading.

And that's it! Once you've got the third policy scoped how you want it, the process will stay almost completely automated. If any computers no longer have the latest version staged, they'll automatically download a new version and stage it in the hidden folder. The only time an admin will need to touch the workflow, other than initiating an erase/install, will be when Apple releases a new version of macOS. When that happens, and you're ready to get the latest version staged on your computers, you simply need to go into that first smart group (Provisioning: Targets for Policy 3) and change the version number to the newly released version. That will force all computers to update the staged version they have to the latest.

<h2>How to use this script:</h2>
Because all of the information is pretty static, there isn't much to do to make sure it runs correctly.<br>

1. First you'll want to make sure you have access to a Jamf Pro Account that has at LEAST the following privileges:
<br>	# READ on Jamf Pro User Accounts and Groups (This will just be used to verify your account's permissions)
<br>	# READ on Sites
<br>	# CREATE/READ on Categories
<br>	# CREATE/DELETE on Computer Extension Attributes
<br>	# CREATE/DELETE on Scripts
<br>	# CREATE/READ/DELETE on Smart Computer Groups
<br>	# CREATE/UPDATE/DELETE on Policies
<br>	- You can make an account with just privileges (which is most recommended) or just use an accound that has Full Access Admin privileges (Note, if your account only has site access, it will NOT work)
2. Boom, once you got that set up, you're ready to run the script!
<br>	- NOTE: You may get a PPPC prompt to allow terminal access to System Events, this is normal and it's because I use Apple Script to make dialog boxes
3. First the script will prompt you with a bunch of information and give you a chance to quit if you're not ready.
4. Next it will prompt you for your Jamf Pro URL; it needs to be entered in this format: https://mycompany.jamfcloud.com (Note: this works on JamfCloud or on-premise servers)
5. Then it will prompt you for the username and password of an admin account. Once entered it will do a privilege check to see if it has all the access it needs.
6. Next it's going to do some stuff in the background, first it will check to see if Sites are configured in your server and if they are it will prompt you to ask which site you would like this workflow created in. If you don't want it associated to any particular site, just hit cancel and it will continue on without a site configured. If you don't have sites configured, it will just go past this step automatically.
7. Next it is going to pack a bunch of xml data into some variables to be used for the API calls. If you want to see exactly what is getting created, feel free to look through the XML data in the script, just make sure NOT to edit anything. One character in the wrong place can cause errors running the script.
8. Then it will do one more check to see if you're ready to create everything, if you hit proceed it will then start creating everything.
9. Now the script will go through and create all of the objects in Jamf Pro. There's a lot of error handling built in so if any of the calls fail, it will imediately roll back and delete anything it has already created and post the error out to the logs.
10. After everything is created it will prompt you and ask if you want to enable the first policy in the process. It's disabled by default in case you don't want your computers to start getting it immediately. It will also tell you how many computers are in scope of the first policy so if that number doesn't look right you can choose to keep it disabled for now and enable it later manually when you're ready. Otherwise if you hit enable, it will send one final API call to enable the policy.
11. The last thing it will ask is if you want to have a DeConstructor script created on your desktop. This is handy if you're not sure you want to keep the workflow, or if you're just testing or creating a demo that you want to nuke later. If you opt into the creation of this script it will take all of the ID numbers of everything that was created and pass them down into the DeConstructor script. Then if you want to delete everything, just run that script from your desktop, enter the username and password of an admin, and it will go through and delete all the pieces.
12. After you're finished, you can view the logs right on your desktop to see everything that was done.

<h2>Final Considerations</h2>
Here are some things to remember:

* After the script runs, Policy 1 will be disabled (unless you selected otherwise) and Policy 3 will be unscoped. It'll be up to you to choose who should have access to reset computers. Here are a couple of recommendations. When it comes to scoping this policy, I've already made the target for you. You'll find a smart group called "Provisioning: Targets for Policy 3". This will include all computers that have successfully staged the latest version of the Install macOS app. Set that group as the target, and now we can limit the scope further. If you have LDAP configured on your Jamf Pro server, then you'll have access to limit the scope to members of a certain LDAP group. Let's say you have a group in Active Directory called "Information Technology" and you only wanted the members of that group to be able to initiate this script. Then on the "Limitations" tab of the scope page, select "Add" and then navigate to the "LDAP/Local Groups" tab. Search for the LDAP group you want to limit this policy to. And boom! Now the reset process will only show up in Self Service on computers when someone from that LDAP group logs into Self Service.
	If, instead, you don't want to (or can't) use LDAP, you could take it out of Self Service and give it a custom trigger that your techs can use to initiate it via Terminal. For example: 

	sudo jamf policy -event resetComputer

* It's important to remember that this process only works with the latest version of the Installer app RELEASED BY APPLE. Since it relies on the "softwareupdate" binary to obtain the installer, we can only get the latest version they release of every major operating system. If you want to stay on a certain release, you'll need to package that up and deploy it manually.

* Every once in a while, the softwareupdate binary fails for one reason or another. The script in the second policy will first check if the Install macOS app actually exists in the /Applications folder and if not it will exit in error. Since it doesn't finish, the computer will stay in scope of Policy 1 and will try to download it again the next day.